# tech-log-parser
Парсер технологического журнала 1С:Предприятие 8.

## Недостатки существующих способов
- Рекомендуемый способ 1С - это скрипты perl и регулярные выражения, это неудобно и медленно.
- В 8.3.25 появилась возможность настроить вывод в формате Json, но он имеет существенный недостаток: получаемый json может иметь дубли, что не позволяет десериализовать его простым способом.

## Состав проекта
Репозиторий содержит в себе несколько проектов:
- [Библиотека](parser) для парсинга технологического журнала, позже будет публиковаться крейт.
- [simple-bench](tests/simple-bench) - консольная утилита для тестирования скорости парсинга, парсит события, посчитывает количество событий и выводит длительность.
- [Конвертер](converter) - консольная утилита для конвертации файлов в формат json.
- Внешняя компонента Native Api для использования из 1С:Предприятие. Еще в разработке.

## Конвертер
Конвертирует файлы и каталоги технологического журнала в формат json.  
Пример конвертации одного файла:
```sh
converter /path/to/23122609.log /path/to/23122609.json
```
Пример конвертации каталога:
```sh
converter /path/to/tech-logs /path/to/tech-logs-json
```
Формат:
```json
{
    "Date": "2023-12-26T09:15:04.544001",
    "Duration": 1,
    "Name": "SCALL",
    "Level": 0,
    "Props": [["process", "rphost"],["OSThread","1"],["ClientID", "1"]]
}
```
## Внешняя компонента
В разработке.

## Пример анализа тех. журнала в формате json
Если читать все события целиком, то это потребует много оперативной памяти - примерно в 10 раз больше, чем размер самого файла. Поэтому предлагается следующая схема чтения по одному событию:
```bsl
ЧтениеJSON = Новый ЧтениеJSON();
ЧтениеJSON.ОткрытьФайл(ИмяФайла);
ЧтениеJSON.Прочитать();

Если ЧтениеJSON.ТипТекущегоЗначения <> ТипЗначенияJSON.НачалоМассива Тогда
    ВызватьИсключение "Некорректный файл";
КонецЕсли;

Пока Истина Цикл
    Событие = ПрочитатьJSON(ЧтениеJSON, Истина);
    ЧтениеJSON.ТипТекущегоЗначения = ТипЗначенияJSON.КонецМассива Тогда
        Прервать;
    КонецЕсли;

    Дата = XMLЗначение(Тип("Дата"), Событие["Date"]);
    Имя = Событие["Name"];
    Длительность = Событие["Duration"]; // В миллисекундах
    Каждого КлючИЗначение Из Событие["Props"] Цикл
        Ключ = КлючИЗначение[0];
        Значение = КлючИЗначение[1];
    КонецЦикла;
КонецЦикла;
ЧтениеJSON.Закрыть();
```

## Сборка проекта
Собрать можно либо установив rust, с помощью команды:
```
cargo build --release
```
Либо можно собрать в контейнерах, требуется установленный `docker` или `podman`, для этого используйте нужный скрипт `build-with-docker-*`
